# 沪深300股票相关矩阵分析与指数增强基金构建

作者：武亦文 吴舜奔 程澄

学号：23110190071

日期：2025-10-30

---

## 1. 研究目的

- 利用随机矩阵理论（Random Matrix Theory, RMT）对沪深300成分股之间的相关结构进行系统刻画，识别噪声与信息主成分，考察市场因子与行业，风格聚类等结构性特征。
- 在降噪后的相关/协方差矩阵基础上，构建面向沪深300的指数增强型投资组合，通过 $\beta$ 因子的约束以方差最小化位目标优化投资仓位，获得可回测的“增强收益，降低风险”的表现。

---

## 2. 课题内容

- 利用上海股票个股价格的日线数据，计算个股价格变动的相关/协方差矩阵。并对相关矩阵进行特征值分析。
- 绘制相关矩阵的特征值谱并与随机矩阵的特征值谱进行比较。
- 对相关矩阵中与随机矩阵的特征值范围内外的特征值相对应的特征向量的分量进行分析，找到各自对应的个股的板块信息。
- 根据讲义中介绍的利用协方差矩阵构建投资组合的方法，以 30-50 个股数据构建基金，例如沪深300指数的ETF。比较使用完整或者去噪音后的协方差矩阵的结果。

---

## 3. 研究方法

### 3.0 数据源

- 标的范围：沪深300指数成分股（样本期：训练窗 2020-10-01 至 2023-10-01；回测窗 2023-10-02 至 2024-09-30）。
- 数据来源：指数及成分股数据来自 Baostock 抓取脚本 `stock_data_crawler_baostock.py` ，已转存为与股票矩阵兼容的列格式，储存在 `stock_matrix` 文件夹下的 `hs300_2014-2024_matrix.csv` 和 `hs300_index_2014-2024_column.csv` 中。

### 3.1 相关与协方差矩阵

- 预处理：
  - 列删除缺失：仅保留在训练窗内完全无缺失的股票列。
  - 索引对齐：按日期对齐股票与指数序列。原始数据维度为 $(T+1)\times N$，数据存储类型为 `pandas` 的 `DataFrame` 格式。
- 收益矩阵：（维度为 $T\times N$）
  - 对数收益率：
    $$R_{t,i}=\log Y_{t,i}-\log Y_{t-1,i},$$
    其中 $Y_{t,i}$ 是日期 $t$ 第 $i$ 支股票的收盘价。对数收益率用于计算相关/协方差矩阵与 RMT 进行对比。对数收益率矩阵由 `compute_profit_matrix` 函数计算。
  - 普通收益率：
    $$r_{t,i}=\frac{Y_{t,i}}{Y_{t-1,i}}-1.$$
    常规定义下的收益率用于回测以及计算夏普比率。普通收益率矩阵由 `compute_profit_matrix_simple` 函数计算。
  - 两种收益率之间的关系：
    $$R_{t,i}=\log(1+r_{t,i})\approx r_{t,i},$$
    当收益率很小的时候，两种收益率近似相等。
- 相关矩阵：（维度为 $N\times N$）
  - 记收益矩阵 $R\in\mathbb{R}^{T\times N}$，按列计算均值 $\mu_i=(1/T)\sum_{t=1}^T r_{t,i}$ 与方差 $\sigma_i^2=(1/T)\sum_{t=1}^T (r_{t,i}-\mu_i)^2$。令均值向量 $\mu=[\mu_1,\mu_2,\ldots,\mu_N]\in\mathbb{R}^{1\times N}$，标准差向量 $\sigma=[\sigma_1,\sigma_2,\ldots,\sigma_N]\in\mathbb{R}^{1\times N}$。
  - 对收益矩阵做标准化后得：
    $$G=\frac{R-\mu}{\sigma}.$$
    这里维度为 $1\times N$ 的向量 $\mu$ 和 $\sigma$ 会在程序中被自动扩展为维度为 $T\times N$ 的矩阵，与 $R$ 的元素进行一一对应的运算，并非矩阵运算。这样做得到的矩阵 $G$ 中的每个元素均值为0，标准差为1，方便后续与Chiral型随机矩阵做比较。
  
  - 接下来即可计算相关矩阵：
    $$C = \frac{1}{T} G^\top G.$$
  - 这部分功能由 `compute_correlation_matrix` 函数实现。
- 协方差矩阵:（维度为 $N\times N$）
  - 直接计算法：
    $$CV_{\text{direct}} = \frac{1}{T} (R-\mu)^\top(R-\mu).$$
    在计算未去噪的协方差矩阵时可以用这个方法，比较简单直接。这部分由 `compute_covariance_matrix_direct` 函数计算。
  - 借助相关矩阵：用标准差对角矩阵 $D=\mathrm{diag}(\sigma)$ 与相关矩阵 $C$ 复原协方差矩阵：
    $$CV=D\,C\,D.$$
    在计算去噪的协方差矩阵时，必须要用这个方法，因为我们首先要让相关矩阵跟Chiral型随机矩阵做比较，去掉其中的一些本征值，而不是直接去掉协方差矩阵的一些本征值。这一部分由 `compute_covariance_matrix` 函数计算。
  

### 3.2 本征值分析与去噪

- 设维度比 $Q=T/N$，根据随机矩阵理论，Chiral型随机矩阵的本征值有上下界：
  $$\lambda_\pm = 1 + \frac{1}{Q} \pm 2\sqrt{\frac{1}{Q}}.$$
- 我们用本征分析函数 `spectral_decomposition` 对相关矩阵 $C$ 的本征系统 $\{\lambda_i,\,\mathbf{u}_i\}_i$（按本征值从大到小排序）进行本征值分解：
  $$C=\sum_{i=1}^N \lambda_i\, \mathbf{u}_i\mathbf{u}_i^\top.$$
- 之后我们可以在 `plot_eigensystem` 函数中将其与随机矩阵的本征值、本征向量的分布图进行比较，完成本课题的前三部分研究内容；
- 我们还可以利用 `denoising` 函数对相关矩阵实施本征值阈值截断，仅保留 $\lambda_i>\lambda_+$ 的本征对，令其他本征值为0，以构造去噪声的相关矩阵：
  $$C_{\mathrm{pr}} = \sum_{\lambda_i>\lambda_+} \lambda_i\, \mathbf{u}_i\mathbf{u}_i^\top.$$
  去噪后进行对称化并将对角线强制设为 1，以保证相关矩阵的对称性和单位对角性质。最后再通过
  $$CV_{\mathrm{pr}}=D\,C_{\mathrm{pr}}\,D$$
    重构去噪声的协方差矩阵，以供后续优化投资组合权重时使用。

### 3.3 股票筛选
- 在构建指数增强ETF时，我们要试图用少量的优质股票构建出比指数表现更好的投资组合，所以首先要对沪深300的成分股进行筛选。筛选的准则为以下两点。
- Pareto 非支配筛选：基于我们前面得到的所有股票的收益矩阵 $R$，计算出每支股票收益的标准差和期望 $(\sigma_i,\mu_i)$，将其都画在 $(\sigma,\mu)$ 平面中，得到一个散点图。我们仅保留未被更高收益且更低波动的股票支配的样本。也即，若我们保留股票 $i$，那么不存在任何股票 $j$ 满足：
  $$\mu_i\leq \mu_j,\quad \sigma_i\geq\sigma_j.$$
- Sharpe 填充：若通过 Pareto 非支配筛选所选出的股票数量少于目标 $K$（这里设置为40），则从剩余股票中按夏普比率 $\mu_i/\sigma_i$ 由高到低补齐至目标数。
- 这个模块由 `clean_profit_matrix` 函数实现。

### 3.4 投资组合权重优化

- 设权重向量 $\omega=[\omega_1,\omega_2,\ldots,\omega_N]\in\mathbb{R}^{1\times N}$，我们接下来试图通过投资组合中成分股 $\beta$ 因子的约束将其优化。
- 个股相对指数的 $\beta$ 因子：
  $$\beta_i=\frac{\mathrm{Cov}(r_i,r_m)}{\sigma_M^2},$$
  其中 $r_i$ 是股票 $i$ 的普通日收益率，$r_M$ 是沪深300指数的普通日收益率，$\mathrm{Cov}(r_i,r_m)$ 是它们在训练窗时间内的协方差，$\sigma_M$ 是沪深300指数普通日收益率在训练窗时间内的标准差。
- 令 $\beta=[\beta_1,\beta_2,\ldots,\beta_N]\in\mathbb{R}^{1\times N}$ 为 $\beta$ 因子向量，记 $u=[1,1,\ldots,1]\in\mathbb{R}^{1\times N}$ 为一个元素全为 1 的行向量，$CV$ 为（去噪或未去噪）协方差矩阵。记：
  $$\begin{aligned}
  uu&=uCV^{-1}u^\top,& ub&=uCV^{-1}\beta^\top,\\
  bu&=\beta CV^{-1}u^\top,& bb&=\beta CV^{-1}\beta^\top.
  \end{aligned}$$
- 在限制条件 $\beta\omega^\top=u\omega^\top=1$下，我们根据拉格朗日乘子法得出最优权重：
  $$\omega=\frac{(bb-ub)\,uCV^{-1}+(uu-bu)\,\beta CV^{-1}}{uu\cdot bb-ub\cdot bu}.$$
- 对比两套协方差矩阵 $CV$：未去噪 $CV_{\text{direct}}$ 与去噪 $CV_{\mathrm{pr}}$，分别代入上式得到两套权重 $\omega$ 与 $\omega_{\mathrm{pr}}$。

### 3.5 回测与评估

- 策略：在回测起点以初始资产 $\mathrm{NAV}_0=100$ 分别按照权重 $\omega$ 与 $\omega_{\mathrm{pr}}$ 建仓并采用“buy-and-hold”策略至窗口末尾，期间不进行调仓。为了与指数收益率做对比，我们直接调取回测窗口内每个交易日的指数数值 $I_t$。
- 回测时间内的累计收益曲线：
  - 第 $t$ 个交易日的基金净值：
    $$\mathrm{NAV}_t = 100\cdot \sum_i \omega_i\,\frac{P_{t,i}}{P_{0,i}}.$$
  - 第 $t$ 个交易日的基金累计收益：
    $$\mathrm{FundCumRet}_t=\frac{\mathrm{NAV}_t}{\mathrm{NAV}_0}-1.$$
  - 第 $t$ 个交易日的指数累计收益：
    $$\mathrm{IndexCumRet}_t=\frac{I_t}{I_0}-1.$$
- 夏普比率计算：
  - 第 $t$ 个交易日的基金日收益：
    $$r_{t}=\frac{\mathrm{NAV}_t}{\mathrm{NAV}_{t-1}}-1,$$
  - 第 $t$ 个交易日的指数日收益：
    $$r_t^\mathrm{index}=\frac{I_t}{I_{t-1}}-1.$$
    分别计算 50/100/150/200 日滚动均值 $\mu$，总体标准差 $\sigma$ 和夏普比率 $\mu/\sigma$；超额夏普用超额日收益率 $r_t- r^{\mathrm{index}}_t$ 计算。

---

## 4. 研究结果

- 相关矩阵谱：训练窗内，$Q=T/N$ 下的 $\lambda_+$ 通常在 1.5~1.7 附近。经验谱在 $\lambda_+$ 右侧存在若干显著的“信息本征值”（如第一主成分对应市场因子），对应的本征向量分量在行业/风格维度上呈现聚类与负载差异。
- 去噪效果：以 $\lambda>\lambda_+$ 截断后重构 $C_{\mathrm{pr}}$，能够削弱噪声本征模式，保留少数信息主成分；设置单位对角后，数值稳定性显著提升，协方差逆求解更稳健。
- 选股集：严格 Pareto 前沿通常给出 10~30 支样本，再通过夏普补齐至 40 支；散点图显示入选样本在低波动高收益区域分布更集中。我们绘制了散点图（紫色为精选集合，黑色为其它），用于观察风险-收益的关系与边界形态：
![选股](/report/pareto_mu_sigma.png)
- 指数增强权重：
  - 基于 $CV_{\text{direct}}$ 的 $\omega$ 权重通常在 $\mathcal{O}(10^{-3}\sim 10^{-1})$ 的数量级。
  - 基于 $CV_{\mathrm{pr}}$ 的 $\omega_{\mathrm{pr}}$ 在添加单位对角与自适应伪逆后，权重幅度与稳定性与 $\omega$ 可比。
- 回测：基金与沪深300 的累计收益曲线三线同图（Fund(CV), Fund(CV_pr), HS300）。在多个窗口下给出基金夏普与超额夏普（示例输出见项目运行日志）。

---

## 5. 讨论与考察

- RMT 与产业结构：最大本征向量往往体现“市场统领因子”，其分量随行业权重与指数构成变化而变化；第 2、3 大及更远位置的主成分可能对应行业簇或风格（成长/价值、大小盘等）。我们在 `eigenvectors_values.png` 中按 $i=1..N$ 展示了本征向量的全体分量，有助于直观看到聚类/分块现象。
- 去噪与对角约束：将去噪相关矩阵对角强制为 1 是保持相关矩阵性质的必要步骤，也在实践上提升了逆协方差的数值稳定性，抑制了权重爆炸。
- 约束与现实交易：本文闭式权重未显式加入做空/换手/成本/行业中性等约束；若在实盘中引入净敞口与行业/风格约束，则可使用二次规划(QP)在去噪协方差下求解，RMT 的稳定性优势仍可延续。
- 稳健性：回测窗口、选股目标数 $K$、Sharpe 填充、β 估计窗口与对数/普通收益口径的差异，都会影响最终表现。应进行多窗口、多起点与灵敏度分析。

---

## 6. 结论

- RMT 去噪能在沪深300 成分股相关结构中分离“噪声谱域”与“信息谱域”，并揭示市场因子及潜在行业/风格结构。
- 在去噪协方差上进行指数增强配置，配合单位对角修正与自适应伪逆求解，可获得数值稳定的闭式权重；回测显示两套组合（CV 与 CV_pr）与指数相比具有可比对照的风险收益特征。
- 后续可扩展：
  - 将 QP 约束优化、行业/风格中性、换手与交易成本纳入；
  - 结合 Ledoit–Wolf 等缩尾/收缩估计与 RMT 去噪；
  - 融合多因子信号与动态窗口，提升增强的持续性。

---

## 7. 参考文献

1. V. Plerou, P. Gopikrishnan, B. Rosenow, L. A. N. Amaral, T. Guhr, and H. E. Stanley, Random matrix approach to cross correlations in financial data, Phys. Rev. E 65, 066126 (2002).
---

## 附：主要符号

- 时间长度：$T$；股票数量：$N$。
- 股价矩阵：$Y$；收益矩阵：$R$；相关矩阵：$C$；协方差矩阵：$CV$；标准差矩阵：$D$。
- 去噪相关矩阵：$C_{\mathrm{pr}}$；去噪协方差矩阵：$CV_{\mathrm{pr}}$

